# v8版本主要做了以下修改

##### 1.增加流水线暂停机制

流水线暂停原理：

- **取指阶段（IF）**：

  **冻结PC值**：暂停期间保持PC不变，阻止新指令进入流水线。

- **译码阶段（ID）**：

  **冻结指令寄存器**：保持当前指令和操作数不变。

- **执行阶段（EX）**：

  **保持操作数不变**：确保除法输入的 `dividend` 和 `divisor` 在暂停期间稳定（波形中70ns~150ns期间数值未变化）。

- **访存（MEM）和写回（WB）阶段**：

  **可正常流动或冻结**：若MEM/WB阶段无长延迟操作，可继续执行（但需确保前序阶段暂停时无新数据传入）。若需完全暂停，将寄存器更新条件与 `stall` 绑定。

- **数据前递与冒险处理**：

  **前递逻辑调整**：暂停期间忽略EX阶段产生的前递数据（避免无效数据污染流水线）

  **控制冒险处理**：暂停期间PC不变，无需处理分支预测错误。

**除法单元仿真波形图**

![image-20250416171410312](../../img/除法单元仿真波形图.png)

当ALU输入操作为除法操作时，`div_inst`信号为高，同时采用时序逻辑电路对其打一拍得到信号`div_inst_r` , 然后对其进行边沿检测，生成单周期的数据有效信号 `data_rdy` 通知除法单元模块进行无符号除法操作，在此期间拉高 `alu_pipestall` 信号执行暂停流水线操作，直到除法单元返回计算完成信号 `res_rdy` 信号，同时拉低`alu_pipestall` 信号解除流水线暂停操作。



##### 2.减少bram的使用，bram使用过多会导致布线困难。将data_mem 深度改为2048，修改后的data_mem大小为32bit*2048=8KB



##### 3.实现M指令集扩展

学习乘法器和除法器IP核

译码模块实现过程：

// 1. 在R-type的处理中，首先检查funct7是否为M扩展的（0000001）。

// 2. 如果是，根据funct3设置对应的alu_op（如ALU_MUL、ALU_MULH等）。

// 3. 否则，继续原来的R-type指令处理，根据funct3和funct7设置alu_op。

// 4. 确保定义了所有相关的宏，如FUNCT7_M，以及各个alu_op的宏。

ALU除法单元实现

ALU模块得到除法运算结果至少需要32个周期后才能得出。

当除法计算数据传入ALU模块后，拉高除法单元的数据有效信号，同时向外发出流水线暂停信号，然后除法单元进入工作状态，当经过至少32个时钟周期后除法单元得出运算结果并拉高res_rdy结果有效信号，alu对外返回计算结果同时拉低流水线暂停信号，除法计算完成。





# 后续计划



### 1.扩展外设（GPIO、UART、DDR3 RAM、数码管、定时器、PWM）

### 2.采用AXI+分层总线架构

```
+----------------+     +-----------------+     +---------------+
| RISC-V CPU     |     | AXI Interconnect|     | DDR3 Controller|
| (AXI Master)   |---->|                 |---->| (AXI Slave)    |
+----------------+     +-----------------+     +---------------+
                        |           |
                        |           |  AXI-to-Legacy Bridge
                        |           v
                        |     +-----------------+
                        |     | Legacy Devices  |
                        |     | (RAM/GPIO/Timer)|
                        |     +-----------------+
                        |
                        v（预留DMA接口）
                  +-----------------+
                  | Future AXI Master|
                  | (e.g., DMA)     |
                  +-----------------+
```

### 3.实现CSR寄存器和相关系统指令，支持中断系统

### 4.扩展指令集（F、D、A指令集），支持单双精度浮点数、原子操作指令

### 5.对SOC时序进行分析